

<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Data Serialization &amp; Power &#8212; ONIX Docs 0.0.0 documentation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" integrity="sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN" crossorigin="anonymous">
    <link href="../../_static/css/index.css" rel="stylesheet">
    <link rel="stylesheet" href="../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script src="../../_static/default.js"></script>
    <script src="../../_static/wavedrom.min.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Making Coaxial Tethers" href="tethers.html" />
    <link rel="prev" title="Headstages" href="index.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="docsearch:language" content="en">
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main">
<div class="container-xl">

    
    <a class="navbar-brand" href="../../index.html">
      <img src="../../_static/onix_logo.svg" class="logo" alt="logo">
    </a>
    
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-menu" aria-controls="navbar-menu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar-menu" class="col-lg-9 collapse navbar-collapse">
      <ul id="navbar-main-elements" class="navbar-nav mr-auto">
        
        
        <li class="nav-item ">
            <a class="nav-link" href="../../About/index.html">About</a>
        </li>
        
        <li class="nav-item active">
            <a class="nav-link" href="../index.html">Hardware Guide</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../../API%20Reference/index.html">API Reference</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../../Software%20Guide/index.html">Software Guides</a>
        </li>
        
        
        <li class="nav-item">
            <a class="nav-link nav-external" href="https://open-ephys.org">Open Ephys<i class="fas fa-external-link-alt"></i></a>
        </li>
        
      </ul>


      

      <ul class="navbar-nav">
        
          <li class="nav-item">
            <a class="nav-link" href="https://github.com/open-ephys/ONI" target="_blank" rel="noopener">
              <span><i class="fab fa-github-square"></i></span>
            </a>
          </li>
        
        
          <li class="nav-item">
            <a class="nav-link" href="https://twitter.com/openephys" target="_blank" rel="noopener">
              <span><i class="fab fa-twitter-square"></i></span>
            </a>
          </li>
        
      </ul>
    </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
          <div class="col-12 col-md-3 bd-sidebar">

<form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form>


<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">

  <div class="bd-toc-item active">
  

  <ul class="nav bd-sidenav">
      
      
      
      
        
          
              <li class="">
                  <a href="../hw-repo-info.html">Repository Information</a>
              </li>
          
        
          
              <li class="">
                  <a href="../hw-compatibility.html">Version Compatibility</a>
              </li>
          
        
          

              <li class="active">
                  <a href="index.html">Headstages</a>
                  <ul>
                  
                      <li class="active">
                          <a href="">Data Serialization & Power</a>
                      </li>
                  
                      <li class="">
                          <a href="tethers.html">Making Coaxial Tethers</a>
                      </li>
                  
                      <li class="">
                          <a href="commutators.html">Headstage Commutators</a>
                      </li>
                  
                      <li class="">
                          <a href="headstage-64_1r3.html">headstage-64 v1.3</a>
                      </li>
                  
                      <li class="">
                          <a href="headstage-neuropix_1r2.html">headstage-neuropix v1.2</a>
                      </li>
                  
                  </ul>
              </li>
          
        
          
              <li class="">
                  <a href="../Miniscopes/index.html">Miniscopes</a>
              </li>
          
        
          
              <li class="">
                  <a href="../Adapters%20%26%20EIBs/index.html">Adapters & EIBs</a>
              </li>
          
        
          
              <li class="">
                  <a href="../Breakout%20Boards/index.html">Breakout Boards</a>
              </li>
          
        
          
              <li class="">
                  <a href="../Hosts/index.html">Hosts</a>
              </li>
          
        
          
              <li class="">
                  <a href="../Datasheets/index.html">Device Datasheets</a>
              </li>
          
        
      
      
      
      
      
      
    </ul>

</nav>
          </div>
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
              
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="nav section-nav flex-column">
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#coaxial-serialization" class="nav-link">Coaxial Serialization</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#power" class="nav-link">Power</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#ds90ub933-4-communication-protocols" class="nav-link">DS90UB933/4 Communication Protocols</a><ul class="nav section-nav flex-column">
                
        <li class="nav-item toc-entry toc-h3">
            <a href="#data-serialization" class="nav-link">Data Serialization</a>
        </li>
    
        <li class="nav-item toc-entry toc-h3">
            <a href="#register-configuration" class="nav-link">Register Configuration</a>
        </li>
    
        <li class="nav-item toc-entry toc-h3">
            <a href="#protocol-transactions-definitions" class="nav-link">Protocol Transactions Definitions:</a>
        </li>
    
        <li class="nav-item toc-entry toc-h3">
            <a href="#course-grained-states-machine" class="nav-link">Course-grained States Machine</a>
        </li>
    
            </ul>
        </li>
    
    </ul>
</nav>


              
          </div>
          

          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="section" id="data-serialization-power">
<span id="serialization"></span><h1>Data Serialization &amp; Power<a class="headerlink" href="#data-serialization-power" title="Permalink to this headline">¶</a></h1>
<p>The major advantage of ONI-compliant headstages, compared to others, is that
they contain onboard logic for controlling and streaming from arbitrary
configurations of head-borne devices using a unified, bidirectional data
stream. In this way, data can be sent to host hardware (see <a class="reference internal" href="../Hosts/index.html#hosts"><span class="std std-ref">Hosts</span></a>) using
modern serializer/deserialzer (SERDES) chips that vastly reduce the amount of
wiring required for communication, or even wirelessly.</p>
<div class="section" id="coaxial-serialization">
<h2>Coaxial Serialization<a class="headerlink" href="#coaxial-serialization" title="Permalink to this headline">¶</a></h2>
<p>ONIX headstages use a coaxial serializer for host communication. This chip
provides power and bidirectional data transmission to and from from the
headstage using a single coaxial cable (one signal wire and an outer shield).
The coaxial cable is the only external connection to the headstage. Power (DC),
a control “back-channel” (MHz), and a data “forward-channel” (GHz)
occupy different portions of the RF spectrum and therefore can be resolved as
distinct signal streams. Any high-quality 50-Ohm characteristic impedance cable
with low loss in the GHz frequency range can be used to make this connection
(e.g. SMA cables). However, the connection to the headstage is usually
accomplished using specialized micro-coax cable that is extremely thin and
flexible. We generally use cables that are 0.2-0.38 mm in diameter.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Have a look at the <a class="reference internal" href="tethers.html#tethers"><span class="std std-ref">Making Coaxial Tethers</span></a> page for more detials on mirco-coax
headstage tethers</p>
</div>
<p>ONIX headstages use an FPGA to control peripheral devices and combine their
data streams prior to serialization. For instance, <a class="reference internal" href="headstage-64_1r3.html#headstage-64-1r3"><span class="std std-ref">headstage-64 v1.3</span></a> and
<a class="reference internal" href="headstage-neuropix_1r2.html#headstage-neuropix-1r2"><span class="std std-ref">headstage-neuropix v1.2</span></a> use an <a class="reference external" href="https://www.intel.com/content/www/us/en/products/programmable/fpga/max-10.html">Intel MAX10 FPGA</a>.
The exact FPGA is not important because every ONI-compliant headstage is uses
very similar gateware (FPGA-based firmware) that performs three major functions</p>
<ol class="arabic simple">
<li><p><strong>Local Hardware Control</strong> Provides hardware controllers (SPI, I2C, etc),
timing, and control logic for each of the sensors and actuators on the
headstage</p></li>
<li><p><strong>Data Streaming</strong> Provides a standard protocol for arbitrating access of
each of the device data streams to the serializer.</p></li>
<li><p><strong>Register Programming</strong> Provides a standard interface for bi-directional
configuration and control of the devices on the headstage.</p></li>
</ol>
</div>
<div class="section" id="power">
<h2>Power<a class="headerlink" href="#power" title="Permalink to this headline">¶</a></h2>
<p>As mentioned in the previous section, power is DC-coupled into the coaxial link
at the host and recovered at the headstage via a second, inductive DC path.
This “T-network” provides a low impedance path for the DC portion of the signal
(power) and rejects the RF components so that they are preserved for
communication between the SERDES pair.</p>
<div class="figure align-center" id="id4">
<img alt="../../_images/rf-t.png" src="../../_images/rf-t.png" />
<p class="caption"><span class="caption-text">LC-network for combining power and data on the coaxial cable.</span><a class="headerlink" href="#id4" title="Permalink to this image">¶</a></p>
</div>
<p>Its important to note that this circuit is completely passive. Therefore
whatever voltage is supplied at the host side will end up at the input to the
headstage. Care must be taken to make sure this voltage is appropriate.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Do not exceed the maximaum voltage at the coaxial input to the
headstage. Make sure you make this measurement at the headstage to account for
a potential voltage drop in the tether. Exceeding this voltage can permanently
damage the headstage.</p>
</div>
<p>Further, if a long and thin coaxial tether is used, the DC resistivity of the
wire can accumulate, resulting in a significant voltage drop across the cable.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Long, thin tethers can have a significant series resistance that
results in a voltage drop across the length of the tether. This may have to be
compensated for by tuning the host input voltage to account for the drop. ONIX
host boards have this ability (e.g. see <a class="reference internal" href="../Hosts/fmc-host_1r3.html#fmc-host-1r3"><span class="std std-ref">fmc-host v1.3</span></a>).</p>
</div>
</div>
<div class="section" id="ds90ub933-4-communication-protocols">
<h2>DS90UB933/4 Communication Protocols<a class="headerlink" href="#ds90ub933-4-communication-protocols" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference external" href="https://www.ti.com/product/DS90UB933-Q1">DS90UB933</a>/<a class="reference external" href="https://www.ti.com/product/DS90UB934-Q1">DS90UB934</a> are a coaxial SERDES pair used on
several ONIX headstages and host modules:</p>
<ul class="simple">
<li><p><a class="reference internal" href="headstage-64_1r3.html#headstage-64-1r3"><span class="std std-ref">headstage-64 v1.3</span></a> (DS90UB933 Serilizer)</p></li>
<li><p><a class="reference internal" href="headstage-neuropix_1r2.html#headstage-neuropix-1r2"><span class="std std-ref">headstage-neuropix v1.2</span></a> (DS90UB933 Serilizer)</p></li>
<li><p><a class="reference internal" href="../Hosts/fmc-host_1r3.html#fmc-host-1r3"><span class="std std-ref">fmc-host v1.3</span></a> (DS90UB934 Deserilizer)</p></li>
</ul>
<p>This section describes how this SERDES pair is used for control of and
communication with headstages.</p>
<div class="section" id="data-serialization">
<h3>Data Serialization<a class="headerlink" href="#data-serialization" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference external" href="https://www.ti.com/product/DS90UB933-Q1">DS90UB933</a> is a 100 MHz
parallel to coaxial serializer that is typically used for streaming camera
data. ONIX headsrages use an intermediate FPGA to translate data from any
number of heterogeneous data sources to the serializer input using the
following simple protocol</p>

<div style="overflow-x:auto">
<script type="WaveDrom">
{
signal: [
  {name: 'pclk', wave: 'P.....|.....'},
  {name: 'hsync', wave: '0.10..|.....', },
  {name: 'vsync', wave: '0.....|.10..', data: ['head', 'body', 'tail', 'data']},
  {name: 'data', wave: 'x.35..|.4x..', data: ['ID', 'frame', 'CRC', 'data']},
],
config: { hscale: 1},
head: {
    text:'DS90UB933 Serialization Protocol',
    tick:0,
},
}
</script>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>where the signal lines are defined as follows:</p>
<dl class="field-list simple">
<dt class="field-odd"><code class="docutils literal notranslate"><span class="pre">plck</span></code></dt>
<dd class="field-odd"><p>The serializers pixel clock, repurposed for generic data
transmission for ONIX headstages.</p>
</dd>
<dt class="field-even"><code class="docutils literal notranslate"><span class="pre">hsync</span></code></dt>
<dd class="field-even"><p>The horizontal synchronization signal, repurposed on ONIX
headstages to indicate the <code class="docutils literal notranslate"><span class="pre">data</span></code> bus contains a device ID on
ONIX headstages</p>
</dd>
<dt class="field-odd"><code class="docutils literal notranslate"><span class="pre">vsync</span></code></dt>
<dd class="field-odd"><p>The vertical synchronization signal, repurposed to indicate the
<code class="docutils literal notranslate"><span class="pre">data</span></code> bus a CRC value for the preceeding packet on ONIX
headstages</p>
</dd>
<dt class="field-even"><code class="docutils literal notranslate"><span class="pre">data</span></code></dt>
<dd class="field-even"><p>The 12-bit data bus containing device ID, CRC value, or device data
depending on the states of <code class="docutils literal notranslate"><span class="pre">hsync</span></code> and <code class="docutils literal notranslate"><span class="pre">vsync</span></code></p>
</dd>
</dl>
<p>The <code class="docutils literal notranslate"><span class="pre">ID</span></code> is the device index within the host device table, <code class="docutils literal notranslate"><span class="pre">frame</span></code> is a
device’s frame data, and <code class="docutils literal notranslate"><span class="pre">CRC</span></code> is a <a class="reference external" href="https://en.wikipedia.org/wiki/Cyclic_redundancy_check">CRC-12</a> of the <code class="docutils literal notranslate"><span class="pre">ID</span></code> and
<code class="docutils literal notranslate"><span class="pre">frame</span></code> elements.  See the  <a class="reference external" href="https://github.com/open-ephys/ONI">ONI Specification</a> for detailed descriptions of these
elements meaning.</p>
<p>These signal lines are present on the FPGA-side of both the serializer and
deserializer, prior to headstage serialization and after host deserialization,
respectively. This means that the serializer link is effectively “invisible”
from the host’s perspective, and the headstage can be treated as if it was just
a module on the host itself.</p>
<p>During serialization, data are transmitted over the coaxial cable
using an RF-encoding scheme called <a class="reference external" href="https://en.wikipedia.org/wiki/FPD-Link">FDP Link III</a> which embeds the clock in the data
stream and allows for active equalization to compensate for imperfections in
the cable. This link uses and 700 MHz carrier for high speed data and provides
a low speed bidirectional link for sending triggers and configuration to the
headstage.</p>
</div>
<div class="section" id="register-configuration">
<h3>Register Configuration<a class="headerlink" href="#register-configuration" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference external" href="https://www.ti.com/product/DS90UB933-Q1">DS90UB933</a>/<a class="reference external" href="https://www.ti.com/product/DS90UB934-Q1">DS90UB934</a> SERDES pair have a I2C-based
backchannel for bidirectional communication. This channel is used for two
purposes in ONIX hardware.</p>
<ol class="arabic simple">
<li><p>Device configuration via register writing and reading. e.g. setting and
bandwidth of the filters on the Intan chip.</p></li>
<li><p>Flashing the headstage FPGA’s non-volatile memory with updated firmware.</p></li>
</ol>
<p>The <a class="reference external" href="https://github.com/open-ephys/ONI">ONI Specification</a> describes a
register programming protocol that is very similar to a simple wishbone bus.
This bus need to be transmitted over the DS90UB933/4 I2C backchannel to be used
to configure headstage devices. The following protocol describes how this is
accomplished.</p>
</div>
<div class="section" id="protocol-transactions-definitions">
<h3>Protocol Transactions Definitions:<a class="headerlink" href="#protocol-transactions-definitions" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul>
<li><p>[ : I2C start</p></li>
<li><p>] : I2C stop</p></li>
<li><p>W : slave device address + I2C write bit</p></li>
<li><p>R : slave device address + I2C read bit</p></li>
<li><dl class="simple">
<dt>Status_result:</dt><dd><ul class="simple">
<li><p>[X, w_busy, w_complete, w_error, r_busy, r_complete, r_error, seq_error]</p></li>
<li><p>seq_error always reset after successful “atomic” sequence</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>Command words:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>0x00 WRITE_ENABLE</p></li>
<li><p>0x01 READ_REQUEST</p></li>
<li><p>0x02 READ_ENABLE_0</p></li>
<li><p>0x03 READ_ENABLE_1</p></li>
<li><p>0x04 READ_ENABLE_2</p></li>
<li><p>0x05 READ_ENABLE_3</p></li>
<li><p>0x06 READ_ENABLE_4</p></li>
<li><p>0x07 STATUS_0</p></li>
<li><p>0x08 STATUS_1</p></li>
<li><p>0xFF INVALID</p></li>
</ol>
</div></blockquote>
</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="course-grained-states-machine">
<h3>Course-grained States Machine<a class="headerlink" href="#course-grained-states-machine" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>IDLE:</p>
<blockquote>
<div><ul class="simple">
<li><dl class="simple">
<dt>if reg_tx.cyc = ‘1’ and reg_tx.we = ‘1’ then</dt><dd><p>goto WRITE_REGISTER</p>
</dd>
<dt>else if reg_tx.cyc = ‘1’ and reg_tx.we = ‘0’ then</dt><dd><p>goto READ_REGISTER</p>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
<p>WRITE_REGISTER:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>[W, WRITE_ENABLE, dev_idx]</p></li>
<li><p>[W, reg_tx.addr(15:8), reg_tx.addr(7:0)]</p></li>
<li><p>[W, reg_tx.val(31:24), reg_tx.val(23:16)]</p></li>
<li><p>[W, reg_tx.val(15:08), reg_tx.val(07:00)]</p></li>
<li><p>[W, STATUS_0, reg_tx.idx]</p></li>
<li><p>[W, STATUS_1, [R, status_result]</p></li>
</ol>
<ul class="simple">
<li><p>Repeat 5 &amp; 6 repeat until status_result(5) = 1</p></li>
<li><p>reg_rx.err &lt;= status_result(4) or status_result(0)</p></li>
<li><p>reg_rx.ack &lt;= ‘1’</p></li>
<li><p>goto CYC_WAIT</p></li>
</ul>
</div></blockquote>
<p>READ_REGISTER:</p>
<blockquote>
<div><blockquote>
<div><blockquote>
<div><ol class="arabic simple">
<li><p>[W, READ_REQUEST, reg_tx.idx]</p></li>
<li><p>[W, reg_tx.addr(15:8), reg_tx.addr(7:0)]</p></li>
<li><p>[W, STATUS_0, reg_tx.idx]</p></li>
<li><p>[W, STATUS_1, [R, status_result]</p></li>
</ol>
<ul class="simple">
<li><p>Repeat 3 &amp; 4 until status_result(5) = 1</p></li>
<li><dl class="simple">
<dt>if status_result(0) or status_result(4)</dt><dd><p>reg_rx.ack &lt;= ‘1’
reg_rx.err &lt;= ‘1’
goto CYC_WAIT</p>
</dd>
<dt>else</dt><dd><p>continue</p>
</dd>
</dl>
</li>
</ul>
<ol class="arabic simple" start="5">
<li><p>[W, READ_ENABLE_0, reg_tx.idx]</p></li>
<li><p>[W, READ_ENABLE_1, [R, reg_rx.val(31:24)]</p></li>
<li><p>[W, READ_ENABLE_2, [R, reg_rx.val(23:16)]</p></li>
<li><p>[W, READ_ENABLE_3, [R, reg_rx.val(15:08)]</p></li>
<li><p>[W, READ_ENABLE_4, [R, reg_rx.val(07:00)]</p></li>
</ol>
</div></blockquote>
<ol class="arabic simple" start="10">
<li><p>[W, STATUS_0, reg_tx.idx]</p></li>
<li><p>[W, STATUS_1, [R, status_result]</p></li>
</ol>
<blockquote>
<div><ul class="simple">
<li><p>reg_rx.err &lt;= status_result(0) or status_result(1)</p></li>
<li><p>reg_rx.ack &lt;= ‘1’</p></li>
<li><p>goto CYC_WAIT</p></li>
</ul>
</div></blockquote>
</div></blockquote>
<p>CYC_WAIT:</p>
<blockquote>
<div><ul class="simple">
<li><p>reg_rx_o.ack &lt;= ‘0’;</p></li>
<li><p>reg_rx_o.err &lt;= ‘0’;</p></li>
<li><dl class="simple">
<dt>if reg_tx.cyc = 0</dt><dd><p>goto IDLE</p>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
</div></blockquote>
</div></blockquote>
</div>
</div>
</div>

    <script type="text/javascript">
        function init() {
            WaveDrom.ProcessAll();
        }
        window.onload = init;
    </script>

              </div>
              
              
              <div class='prev-next-bottom'>
                
    <a class='left-prev' id="prev-link" href="index.html" title="previous page">Headstages</a>
    <a class='right-next' id="next-link" href="tethers.html" title="next page">Making Coaxial Tethers</a>

              </div>
              
          </main>
          

      </div>
    </div>

    <script src="../../_static/js/index.js"></script>
    <footer class="footer mt-5 mt-md-0">
  <div class="container">
    <p>
          &copy; Copyright 2010-2020, Open Ephys &amp; Contributors.<br/>
        Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.2.0.<br/>
    </p>
  </div>
</footer>
  </body>
</html>